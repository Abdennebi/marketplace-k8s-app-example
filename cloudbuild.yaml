steps:

- id: Initialize git
  name: gcr.io/cloud-builders/git
  entrypoint: /bin/bash
  args:
  - -exc
  - |
    # Cloud Build x GitHub integration uses source archives to fetch
    # the source, rather than Git source fetching, and as a consequence
    # does not include the .git/ directory. As a workaround, we clone
    # the repository and reset it to this build's commit sha.
    git clone 'https://github.com/GoogleCloudPlatform/marketplace-k8s-app-example.git' tmp
    mv tmp/.git .git
    rm -rf tmp
    git reset "$COMMIT_SHA"
    git submodule sync --recursive
    git submodule update --init --recursive

- id: Get Kubernetes Credentials
  name: gcr.io/cloud-builders/gcloud
  args:
  - container
  - clusters
  - get-credentials
  - "limani-integ"
  - --region
  - "us-central1"
  - --project
  - "$PROJECT_ID"

- id: Build dev
  name: gcr.io/cloud-builders/docker
  waitFor:
  - Initialize git
  dir: vendor/marketplace-tools
  args:
  - build
  - --tag
  - gcr.io/cloud-marketplace-tools/k8s/dev:latest
  - --file
  - marketplace/dev/Dockerfile
  - .

- id: Initialized
  name: gcr.io/cloud-builders/docker
  entrypoint: /bin/bash
  waitFor:
  - Get Kubernetes Credentials
  - Build dev
  args:
  - -exc
  - |
    cp -r /builder/home/.kube /workspace/kube/
    cp -r /builder/home/.config /workspace/config/
    df -h
    docker run \
        --mount "type=tmpfs,source=/builder/home/.kube,target=/root/mount/.kube,readonly" \
        --mount "type=tmpfs,source=/builder/home/.config,target=/root/mount/.config,readonly" \
        --link metadata:metadata.google.internal \
        --rm \
        --entrypoint=bash \
        gcr.io/cloud-marketplace-tools/k8s/dev:latest \
        -exc \
        -- \
        "find /root/mount/ ; ls -l /root/ ; df -h ; source setup_kubeconfig.sh ; gcloud auth list ; kubectl get namespace"
